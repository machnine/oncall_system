<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    {% if not is_admin_view %}
        // Show/hide action buttons on row hover (only for non-admin views)
        document.querySelectorAll('tbody tr').forEach(function(row) {
            // Skip collapsed detail rows
            if (row.classList.contains('collapse')) return;
            
            row.addEventListener('mouseenter', function() {
                const actions = this.querySelector('.block-actions, .entry-actions');
                if (actions) {
                    actions.style.opacity = '1';
                }
            });
            
            row.addEventListener('mouseleave', function() {
                const actions = this.querySelector('.block-actions, .entry-actions');
                if (actions) {
                    actions.style.opacity = '0';
                }
            });
        });

        // Handle hover for nested time entry rows
        document.querySelectorAll('.collapse tbody tr').forEach(function(row) {
            row.addEventListener('mouseenter', function() {
                const actions = this.querySelector('.entry-actions');
                if (actions) {
                    actions.style.opacity = '1';
                }
            });
            
            row.addEventListener('mouseleave', function() {
                const actions = this.querySelector('.entry-actions');
                if (actions) {
                    actions.style.opacity = '0';
                }
            });
        });
    {% endif %}

    // Handle chevron rotation on collapse toggle
    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]:not(#toggleAllBlocks)');
    collapseElements.forEach(function(element) {
        var target = document.querySelector(element.getAttribute('data-bs-target'));
        var chevron = element.querySelector('i');
        
        target.addEventListener('show.bs.collapse', function () {
            chevron.classList.remove('bi-caret-down');
            chevron.classList.add('bi-caret-up');
            element.setAttribute('aria-expanded', 'true');
        });
        
        target.addEventListener('hide.bs.collapse', function () {
            chevron.classList.remove('bi-caret-up');
            chevron.classList.add('bi-caret-down');
            element.setAttribute('aria-expanded', 'false');
        });
    });

    // Handle toggle all blocks
    var toggleAllBtn = document.getElementById('toggleAllBlocks');
    if (toggleAllBtn) {
        
        toggleAllBtn.addEventListener('click', function() {
            var blockCollapses = document.querySelectorAll('[id^="block-"]');
            var toggleIcon = this.querySelector('i');
            
            // Use the button's current icon state to determine action
            var isCurrentlyShowingCollapseIcon = toggleIcon.classList.contains('bi-caret-up');
            
            if (isCurrentlyShowingCollapseIcon) {
                // Button is showing "collapse" icon, so collapse ALL
                blockCollapses.forEach(function(collapse) {
                    var bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapse);
                    bsCollapse.hide();
                });
                toggleIcon.className = 'bi bi-caret-down';                
                this.setAttribute('title', 'Expand all blocks');
            } else {
                // Button is showing "expand" icon, so expand ALL
                blockCollapses.forEach(function(collapse) {
                    var bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapse);
                    bsCollapse.show();
                });
                toggleIcon.className = 'bi bi-caret-up';                
                this.setAttribute('title', 'Collapse all blocks');
            }
            
            // Update Bootstrap tooltip
            var existingTooltip = bootstrap.Tooltip.getInstance(this);
            if (existingTooltip) {
                existingTooltip.dispose();
            }
            new bootstrap.Tooltip(this);
        });
    }
});
</script>